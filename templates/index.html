<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Flood Early Warning System (Rainfall Prediction + Fuzzy Risk)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; background: #f6f7fb; }
    .container { max-width: 980px; margin: 0 auto; }
    h1 { margin-bottom: 6px; }
    .subtitle { color: #555; margin-top: 0; }

    .card { background: white; border-radius: 14px; padding: 18px; box-shadow: 0 8px 18px rgba(0,0,0,0.06); margin-top: 16px; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    @media (max-width: 820px) { .grid { grid-template-columns: 1fr; } }

    label { font-size: 13px; color: #333; display:block; margin-bottom: 6px; }
    input[type="number"], textarea {
      width: 100%; padding: 10px; border: 1px solid #d7d9e0; border-radius: 10px; outline: none;
      background: #fff;
    }
    textarea { resize: vertical; }

    .row { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button {
      padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer;
      background: #2d6cdf; color: white; font-weight: 600;
    }
    button.secondary { background: #6b7280; }
    button.danger { background: #b91c1c; }

    .toggle { display:flex; gap: 8px; align-items:center; margin-top: 12px; user-select: none; }
    .toggle input { transform: scale(1.1); }

    .result { border-radius: 12px; padding: 14px; margin-top: 12px; color: #111; border: 1px solid #eee; }
    .green { background: #eaf7ee; border-color: #b8e3c5; }
    .yellow { background: #fff9db; border-color: #fde68a; }
    .orange { background: #fff0e6; border-color: #fdba74; }
    .red { background: #ffe4e6; border-color: #fca5a5; }

    .meta { font-size: 13px; color: #444; margin-top: 6px; }
    .small { font-size: 12px; color: #666; }
    .hr { height: 1px; background: #eee; margin: 12px 0; border: 0; }

    code { background: #f1f5f9; padding: 2px 6px; border-radius: 6px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#1f2a72; font-size:12px; margin-left:6px;}
  </style>
</head>
<body>
<div class="container">
  <h1>Flood Early Warning System</h1>
  <p class="subtitle">LSTM rainfall forecasting (3-hour horizon) + <b>Fuzzy Logic</b> flood-risk confidence</p>
  <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
    <a href="/data" style="background:#2d6cdf; color:white; padding:7px 16px; border-radius:8px; text-decoration:none; font-weight:600; font-size:13px;">üìä View Saved Data</a>
    <a href="/docs" style="background:#7c3aed; color:white; padding:7px 16px; border-radius:8px; text-decoration:none; font-weight:600; font-size:13px;">üìÑ Documentation</a>
  </div>

  <!-- Input Card -->
  <div class="card">
    <h2 style="margin-top:0;">Observed Weather Input (10-min step)</h2>
    <p class="small">
      LSTM input window uses <b>119</b> rows of feature history + current input.<br/>
      <b>Save Observed Input</b> appends to <code>data/input.csv</code> (past feature observations).<br/>
      <span class="small">Input validation: T [-10..60], rh [0..100], p [850..1100], wv [0..60], max_wv [0..100], raining {0,1}.</span>
    </p>

    <div class="grid">
      <div>
        <label for="T">Temperature (T)</label>
        <input id="T" type="number" step="any" placeholder="e.g., 28.5" min="-10" max="60">
      </div>
      <div>
        <label for="rh">Relative Humidity (rh)</label>
        <input id="rh" type="number" step="any" placeholder="e.g., 85" min="0" max="100">
      </div>
      <div>
        <label for="p">Pressure (p)</label>
        <input id="p" type="number" step="any" placeholder="e.g., 1008" min="850" max="1100">
      </div>

      <div>
        <label for="wv">Wind Velocity (wv)</label>
        <input id="wv" type="number" step="any" placeholder="e.g., 4.2" min="0" max="60">
      </div>
      <div>
        <label for="max_wv">Max Wind Velocity (max. wv)</label>
        <input id="max_wv" type="number" step="any" placeholder="e.g., 7.8" min="0" max="100">
      </div>
      <div>
        <label for="raining">Raining (0 or 1)</label>
        <input id="raining" type="number" step="1" min="0" max="1" placeholder="0 or 1">
      </div>
    </div>

    <div class="toggle">
      <input type="checkbox" id="autoRoll" checked>
      <label for="autoRoll" style="margin:0;">
        Auto-roll predicted rain into history (move ONLY 1√ó10-min value from previous forecast into historical rain each time)
      </label>
    </div>

    <div class="row">
      <button onclick="saveData()">Save Observed Input</button>
      <button onclick="predict()">Predict Flood Risk</button>
      <button class="danger" onclick="resetAutoHistory()">Reset Auto History</button>
    </div>

    <div id="saveStatus" class="meta"></div>
  </div>

  <!-- Simulation Card -->
  <div class="card">
    <h2 style="margin-top:0;">Simulation Mode (Future Rainfall Scenario)</h2>
    <p class="small">
      Simulation mode bypasses the ML forecast and uses <code>bulk_save.csv</code> as the next <b>future</b> 3-hour rainfall series.
      Each prediction call consumes <b>1 step</b> (10 minutes).
    </p>

    <div class="toggle">
      <input type="checkbox" id="simulationMode">
      <label for="simulationMode" style="margin:0;">
        Enable Simulation Mode (use <code>bulk_save.csv</code> forecast instead of model)
      </label>
    </div>

    <label style="margin-top:12px; font-weight:bold;">
      Paste rainfall series (mm per 10-min, comma separated)
    </label>
    <textarea id="rainSeries" rows="4"
      placeholder="Example: 0.2,0.3,0.5,0.8,1.2,1.8,2.6,3.4,4.2,4.8,5.0,5.0,4.8,4.5,4.1,3.6,3.0,2.4"></textarea>

    <div class="row">
      <button class="secondary" onclick="uploadScenario(true)">Upload Scenario (overwrite)</button>
      <button class="secondary" onclick="uploadScenario(false)">Append Scenario</button>
      <button class="danger" onclick="resetScenario()">Reset Scenario Cursor</button>
    </div>

    <div id="simStatus" class="meta"></div>
  </div>

  <!-- Output Card -->
  <div class="card">
    <h2 style="margin-top:0;">Prediction Output</h2>
    <div id="output" class="small">No prediction yet.</div>
  </div>

</div>

<script>
function collectInput() {
  return {
    "T": document.getElementById("T").value,
    "rh": document.getElementById("rh").value,
    "p": document.getElementById("p").value,
    "wv": document.getElementById("wv").value,
    "max. wv": document.getElementById("max_wv").value,
    "raining": document.getElementById("raining").value,
    "simulation_mode": document.getElementById("simulationMode").checked,
    "auto_roll": document.getElementById("autoRoll").checked
  };
}

function parseRainSeries() {
  const raw = (document.getElementById("rainSeries").value || "").trim();
  if (!raw) return [];
  return raw
    .split(",")
    .map(x => Number(x.trim()))
    .filter(x => !Number.isNaN(x));
}

function setStatus(id, msg, isError=false) {
  const el = document.getElementById(id);
  el.style.color = isError ? "#b91c1c" : "#2563eb";
  el.textContent = msg;
}

function saveData() {
  setStatus("saveStatus", "Saving observed input...");
  fetch("/save", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(collectInput())
  })
  .then(async res => {
    const data = await res.json().catch(() => ({error: "Server returned non-JSON response"}));
    if (!res.ok) throw new Error(data.error || ("HTTP " + res.status));
    return data;
  })
  .then(data => {
    setStatus("saveStatus", data.message + " (" + data.path + ")");
  })
  .catch(err => {
    setStatus("saveStatus", "Save failed: " + err.message, true);
  });
}

function uploadScenario(overwrite) {
  const series = parseRainSeries();
  if (series.length === 0) {
    setStatus("simStatus", "Paste a rainfall series first.", true);
    return;
  }

  setStatus("simStatus", overwrite ? "Uploading (overwrite)..." : "Appending...");
  fetch("/bulk_upload", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ rain_series: series, overwrite: !!overwrite })
  })
  .then(async res => {
    const data = await res.json().catch(() => ({error: "Server returned non-JSON response"}));
    if (!res.ok) throw new Error(data.error || ("HTTP " + res.status));
    return data;
  })
  .then(data => {
    setStatus("simStatus", `${data.message} Cursor idx: ${data.cursor_idx}. ${data.note}`);
  })
  .catch(err => {
    setStatus("simStatus", "Upload failed: " + err.message, true);
  });
}

function resetScenario() {
  setStatus("simStatus", "Resetting cursor...");
  fetch("/bulk_reset", { method: "POST" })
  .then(async res => {
    const data = await res.json().catch(() => ({error: "Server returned non-JSON response"}));
    if (!res.ok) throw new Error(data.error || ("HTTP " + res.status));
    return data;
  })
  .then(data => {
    setStatus("simStatus", data.message + " Cursor idx: " + data.cursor_idx);
  })
  .catch(err => {
    setStatus("simStatus", "Reset failed: " + err.message, true);
  });
}

function resetAutoHistory() {
  setStatus("saveStatus", "Resetting auto history...");
  fetch("/reset_auto_history", { method: "POST" })
  .then(async res => {
    const data = await res.json().catch(() => ({error: "Server returned non-JSON response"}));
    if (!res.ok) throw new Error(data.error || ("HTTP " + res.status));
    return data;
  })
  .then(data => {
    setStatus("saveStatus", data.message);
  })
  .catch(err => {
    setStatus("saveStatus", "Reset failed: " + err.message, true);
  });
}

function predict() {
  const payload = collectInput();

  setStatus("saveStatus", "");
  document.getElementById("output").textContent = "Predicting...";

  fetch("/predict", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  })
  .then(async res => {
    const data = await res.json().catch(() => ({error: "Server returned non-JSON response"}));
    if (!res.ok) throw new Error(data.error || ("HTTP " + res.status));
    return data;
  })
  .then(data => {
    let cls = "green";
    if (data.alert_level === "Yellow") cls = "yellow";
    if (data.alert_level === "Orange") cls = "orange";
    if (data.alert_level === "Red") cls = "red";

    const riskPct = (data.flood_risk_confidence * 100).toFixed(1);
    const totalMM = Number(data.forecast_total_mm).toFixed(2);
    const peakMM  = Number(data.forecast_peak_mm_per_step).toFixed(2);
    const hours   = data.forecast_horizon_hours;

    const explainHtml = (data.explanation || [])
      .map(x => `<li>${x}</li>`)
      .join("");

    const mode = data.mode || "model";
    const engine = data.risk_engine || "unknown";

    const cursor = (mode === "simulation" && data.simulation_cursor_idx !== null && data.simulation_cursor_idx !== undefined)
      ? `Simulation cursor idx: <b>${data.simulation_cursor_idx}</b>`
      : "";

    const rolled = (data.rolled_in_rain_mm !== null && data.rolled_in_rain_mm !== undefined)
      ? `Auto-rolled into history (previous forecast first step): <b>${Number(data.rolled_in_rain_mm).toFixed(2)} mm</b>`
      : "";

    document.getElementById("output").innerHTML = `
      <div class="result ${cls}">
        <div><b>Mode:</b> ${mode} <span class="pill">${engine}</span></div>
        <div><b>Auto-roll:</b> ${data.auto_roll ? "ON" : "OFF"}</div>
        ${cursor ? `<div class="small">${cursor}</div>` : ``}
        ${rolled ? `<div class="small">${rolled}</div>` : ``}
        <hr class="hr">
        <div><b>Alert Level:</b> ${data.alert_level}</div>
        <div><b>Flood Risk Confidence:</b> ${riskPct}%</div>
        <div><b>Forecast Total (next ${hours}h):</b> ${totalMM} mm</div>
        <div><b>Forecast Peak (per ${data.data_frequency_minutes || 10}-min):</b> ${peakMM} mm</div>
        <hr class="hr">
        <div><b>Why (risk explanation):</b></div>
        <ul>${explainHtml}</ul>
      </div>
      <div class="small" style="margin-top:10px; color:#555;">
        Tip: If you want ‚Äúraining=0 ‚Üí forecast almost 0‚Äù, increase the soft multiplier damping in the Python file (NOT_RAINING_MULTIPLIER).
      </div>
    `;
  })
  .catch(err => {
    document.getElementById("output").innerHTML =
      `<div class="result red"><b>Error:</b> ${err.message}</div>`;
  });
}
</script>

</body>
</html>